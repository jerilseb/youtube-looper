{"version":3,"sources":["main.js"],"names":["window","addEventListener","initialize","initialized","waitForVideo","observer","MutationObserver","mutations","requestIdleCallback","_","forEach","mutation","Array","prototype","call","addedNodes","node","nodeName","disconnect","console","log","timeout","observe","document","childList","subtree","container","querySelector","video","parentNode","mainInterval","leftMarker","rightMarker","controlsActive","rightControls","template","createElement","innerHTML","toggleButton","content","firstElementChild","subtitlesButton","insertBefore","e","classList","add","insertMarkers","duration","remove","removeMarkers","disableLoopButton","loopIcon","clearInterval","leftTime","rightTime","setAttribute","appendChild","ondragstart","arrowWidth","offsetWidth","shiftX","setPosition","arrow","position","left","requestAnimationFrame","style","getPosition","offsetLeft","event","preventDefault","rightMarkerposition","containerLeft","getBoundingClientRect","containerWidth","onMouseMove","clientX","percentage","toFixed","parseFloat","removeEventListener","once","leftMarkerposition","setInterval","time","currentTime","watchForSouceChange","type","attributeName","attributes"],"mappings":"AAAAA,MAAM,CAACC,gBAAP,CAAwB,MAAxB,EAAgCC,UAAhC;AACA,IAAIC,WAAW,GAAG,KAAlB;;AAEA,SAASC,YAAT,GAAwB;AACtB,MAAIC,QAAQ,GAAG,IAAIC,gBAAJ,CAAqB,UAAAC,SAAS,EAAI;AAC/CC,IAAAA,mBAAmB,CAAC,UAAAC,CAAC,EAAI;AACvBF,MAAAA,SAAS,CAACG,OAAV,CAAkB,UAAAC,QAAQ,EAAI;AAC5BC,QAAAA,KAAK,CAACC,SAAN,CAAgBH,OAAhB,CAAwBI,IAAxB,CAA6BH,QAAQ,CAACI,UAAtC,EAAkD,UAAAC,IAAI,EAAI;AACxD,cAAI,CAACb,WAAD,IAAgBa,IAAI,CAACC,QAAL,KAAkB,OAAtC,EAA+C;AAC7CZ,YAAAA,QAAQ,CAACa,UAAT;AACAC,YAAAA,OAAO,CAACC,GAAR,CAAY,2BAAZ;AACAlB,YAAAA,UAAU;AACX;AACF,SAND;AAOD,OARD;AASD,KAVkB,EAUhB;AAACmB,MAAAA,OAAO,EAAE;AAAV,KAVgB,CAAnB;AAWD,GAZc,CAAf;AAaAhB,EAAAA,QAAQ,CAACiB,OAAT,CAAiBC,QAAjB,EAA2B;AAAEC,IAAAA,SAAS,EAAE,IAAb;AAAmBC,IAAAA,OAAO,EAAE;AAA5B,GAA3B;AACD;;AAED,SAASvB,UAAT,GAAsB;AACpB,MAAIwB,SAAS,GAAGH,QAAQ,CAACI,aAAT,CAAuB,uBAAvB,CAAhB;;AACA,MAAG,CAACxB,WAAD,IAAgBuB,SAAS,KAAK,IAAjC,EAAuC;AACrCP,IAAAA,OAAO,CAACC,GAAR,CAAY,uCAAZ;AACAhB,IAAAA,YAAY;AACZ;AACD;;AAAA;AAED,MAAIwB,KAAK,GAAGF,SAAS,CAACG,UAAV,CAAqBF,aAArB,CAAmC,OAAnC,CAAZ;;AACA,MAAG,CAACxB,WAAD,IAAgByB,KAAK,KAAK,IAA7B,EAAmC;AACjCT,IAAAA,OAAO,CAACC,GAAR,CAAY,mCAAZ;AACAhB,IAAAA,YAAY;AACZ;AACD;;AAEDe,EAAAA,OAAO,CAACC,GAAR,CAAY,4BAAZ;AACAjB,EAAAA,WAAW,GAAG,IAAd;AAEA,MAAI2B,YAAY,GAAG,IAAnB;AACA,MAAIC,UAAU,GAAG,IAAjB;AACA,MAAIC,WAAW,GAAG,IAAlB,CApBoB,CAsBpB;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,MAAIC,cAAc,GAAG,KAArB;AAEA,MAAMC,aAAa,GAAGR,SAAS,CAACC,aAAV,CAAwB,qBAAxB,CAAtB;AACA,MAAMQ,QAAQ,GAAGZ,QAAQ,CAACa,aAAT,CAAuB,UAAvB,CAAjB;AACAD,EAAAA,QAAQ,CAACE,SAAT;AAMA,MAAMC,YAAY,GAAGH,QAAQ,CAACI,OAAT,CAAiBC,iBAAtC;AAEA,MAAMC,eAAe,GAAGf,SAAS,CAACC,aAAV,CAAwB,uBAAxB,CAAxB;AACAO,EAAAA,aAAa,CAACQ,YAAd,CAA2BJ,YAA3B,EAAyCG,eAAzC;AAEAH,EAAAA,YAAY,CAACrC,gBAAb,CAA8B,OAA9B,EAAuC,UAAA0C,CAAC,EAAI;AAC1CV,IAAAA,cAAc,GAAG,CAACA,cAAlB;;AACA,QAAGA,cAAH,EAAmB;AACjBK,MAAAA,YAAY,CAACM,SAAb,CAAuBC,GAAvB,CAA2B,QAA3B;AACAC,MAAAA,aAAa,CAAClB,KAAK,CAACmB,QAAP,CAAb;AACD,KAHD,MAGO;AACLT,MAAAA,YAAY,CAACM,SAAb,CAAuBI,MAAvB,CAA8B,QAA9B;AACAC,MAAAA,aAAa;AACd;AACF,GATD;;AAWA,WAASC,iBAAT,GAA6B;AAC3BjB,IAAAA,cAAc,GAAG,KAAjB;AACAkB,IAAAA,QAAQ,CAACP,SAAT,CAAmBI,MAAnB,CAA0B,QAA1B;AACAC,IAAAA,aAAa;AACd;;AAED,WAASA,aAAT,GAAyB;AACvB9B,IAAAA,OAAO,CAACC,GAAR,CAAY,uBAAZ;AACAgC,IAAAA,aAAa,CAACtB,YAAD,CAAb;AACAC,IAAAA,UAAU,CAACiB,MAAX;AACAhB,IAAAA,WAAW,CAACgB,MAAZ;AACD;;AAED,WAASF,aAAT,CAAuBC,QAAvB,EAAiC;AAC/B5B,IAAAA,OAAO,CAACC,GAAR,CAAY,yBAAZ;AACA,QAAIiC,QAAQ,GAAG,CAAf;AACA,QAAIC,SAAS,GAAGP,QAAhB;AAEAhB,IAAAA,UAAU,GAAGR,QAAQ,CAACa,aAAT,CAAuB,KAAvB,CAAb;AACAL,IAAAA,UAAU,CAACwB,YAAX,CAAwB,OAAxB,EAAiC,0BAAjC;AACA7B,IAAAA,SAAS,CAAC8B,WAAV,CAAsBzB,UAAtB;AAEAC,IAAAA,WAAW,GAAGT,QAAQ,CAACa,aAAT,CAAuB,KAAvB,CAAd;AACAJ,IAAAA,WAAW,CAACuB,YAAZ,CAAyB,OAAzB,EAAkC,2BAAlC;AACA7B,IAAAA,SAAS,CAAC8B,WAAV,CAAsBxB,WAAtB;;AAEAD,IAAAA,UAAU,CAAC0B,WAAX,GAAyB;AAAA,aAAM,KAAN;AAAA,KAAzB;;AACAzB,IAAAA,WAAW,CAACyB,WAAZ,GAA0B;AAAA,aAAM,KAAN;AAAA,KAA1B;;AAEA,QAAIC,UAAU,GAAG3B,UAAU,CAAC4B,WAA5B;AACA,QAAIC,MAAM,GAAGF,UAAU,GAAG,CAA1B;;AAEA,aAASG,WAAT,CAAqBC,KAArB,EAA4BC,QAA5B,EAAsC;AACpC,UAAIC,IAAI,GAAID,QAAQ,GAAGH,MAAZ,GAAsB,IAAjC;AACAK,MAAAA,qBAAqB,CAAC,YAAM;AAC1BH,QAAAA,KAAK,CAACI,KAAN,CAAYF,IAAZ,GAAmBA,IAAnB;AACD,OAFoB,CAArB;AAGD;;AAED,aAASG,WAAT,CAAqBL,KAArB,EAA4B;AAC1B,aAAQA,KAAK,CAACM,UAAN,GAAmBR,MAA3B;AACD;;AAED7B,IAAAA,UAAU,CAAC9B,gBAAX,CAA4B,WAA5B,EAAyC,UAAAoE,KAAK,EAAI;AAChDA,MAAAA,KAAK,CAACC,cAAN;AACA,UAAMC,mBAAmB,GAAGJ,WAAW,CAACnC,WAAD,CAAvC;AACA,UAAMwC,aAAa,GAAG9C,SAAS,CAAC+C,qBAAV,GAAkCT,IAAxD;AACA,UAAIU,cAAc,GAAGhD,SAAS,CAACiC,WAA/B;AACA,UAAII,QAAQ,GAAG,CAAf;AAEAxC,MAAAA,QAAQ,CAACtB,gBAAT,CAA0B,WAA1B,EAAuC0E,WAAvC;;AACA,eAASA,WAAT,CAAqBN,KAArB,EAA4B;AAC1BN,QAAAA,QAAQ,GAAGM,KAAK,CAACO,OAAN,GAAgBJ,aAA3B;;AACA,YAAGT,QAAQ,GAAGQ,mBAAX,IAAkCR,QAAQ,IAAI,CAA9C,IAAmDA,QAAQ,IAAIW,cAAlE,EAAkF;AAChFb,UAAAA,WAAW,CAAC9B,UAAD,EAAagC,QAAb,CAAX;AACD;AACF;;AAEDxC,MAAAA,QAAQ,CAACtB,gBAAT,CAA0B,SAA1B,EAAqC,UAAAoE,KAAK,EAAI;AAC5CA,QAAAA,KAAK,CAACC,cAAN;AACA,YAAIO,UAAU,GAAG,CAAC,MAAM9C,UAAU,CAACqC,UAAjB,GAA8BM,cAA/B,EAA+CI,OAA/C,CAAuD,CAAvD,CAAjB;AACA/C,QAAAA,UAAU,CAACmC,KAAX,CAAiBF,IAAjB,GAAwBa,UAAU,GAAG,GAArC;AACAxB,QAAAA,QAAQ,GAAIN,QAAQ,GAAGgC,UAAU,CAACF,UAAD,CAArB,GAAoC,GAAhD;AACAtD,QAAAA,QAAQ,CAACyD,mBAAT,CAA6B,WAA7B,EAA0CL,WAA1C;AACD,OAND,EAMG;AAAEM,QAAAA,IAAI,EAAE;AAAR,OANH;AAOD,KAtBD;AAwBAjD,IAAAA,WAAW,CAAC/B,gBAAZ,CAA6B,WAA7B,EAA0C,UAAAoE,KAAK,EAAI;AACjDA,MAAAA,KAAK,CAACC,cAAN;AACA,UAAMY,kBAAkB,GAAGf,WAAW,CAACpC,UAAD,CAAtC;AACA,UAAMyC,aAAa,GAAG9C,SAAS,CAAC+C,qBAAV,GAAkCT,IAAxD;AACA,UAAIU,cAAc,GAAGhD,SAAS,CAACiC,WAA/B;AACA,UAAII,QAAQ,GAAG,CAAf;AAEAxC,MAAAA,QAAQ,CAACtB,gBAAT,CAA0B,WAA1B,EAAuC0E,WAAvC;;AACA,eAASA,WAAT,CAAqBN,KAArB,EAA4B;AAC1BN,QAAAA,QAAQ,GAAGM,KAAK,CAACO,OAAN,GAAgBJ,aAA3B;;AACA,YAAGT,QAAQ,GAAGmB,kBAAX,IAAiCnB,QAAQ,IAAI,CAA7C,IAAkDA,QAAQ,IAAIW,cAAjE,EAAiF;AAC/Eb,UAAAA,WAAW,CAAC7B,WAAD,EAAc+B,QAAd,CAAX;AACD;AACF;;AAEDxC,MAAAA,QAAQ,CAACtB,gBAAT,CAA0B,SAA1B,EAAqC,UAAAoE,KAAK,EAAI;AAC5CA,QAAAA,KAAK,CAACC,cAAN;AACA,YAAIO,UAAU,GAAG,CAAC,MAAM7C,WAAW,CAACoC,UAAlB,GAA+BM,cAAhC,EAAgDI,OAAhD,CAAwD,CAAxD,CAAjB;AACA9C,QAAAA,WAAW,CAACkC,KAAZ,CAAkBF,IAAlB,GAAyBa,UAAU,GAAG,GAAtC;AACAvB,QAAAA,SAAS,GAAIP,QAAQ,GAAGgC,UAAU,CAACF,UAAD,CAArB,GAAoC,GAAjD;AACAtD,QAAAA,QAAQ,CAACyD,mBAAT,CAA6B,WAA7B,EAA0CL,WAA1C;AACD,OAND,EAMG;AAAEM,QAAAA,IAAI,EAAE;AAAR,OANH;AAOD,KAtBD;AAwBAnD,IAAAA,YAAY,GAAGqD,WAAW,CAAC,YAAM;AAC/B,UAAIC,IAAI,GAAGxD,KAAK,CAACyD,WAAjB;;AACA,UAAGD,IAAI,GAAI9B,SAAS,GAAG,CAApB,IAA0B8B,IAAI,GAAG/B,QAApC,EAA8C;AAC5CzB,QAAAA,KAAK,CAACyD,WAAN,GAAoBhC,QAApB;AACD;AACF,KALyB,EAKvB,IALuB,CAA1B;AAOAiC,IAAAA,mBAAmB,CAAC1D,KAAD,CAAnB;AACD;;AAED,WAAS0D,mBAAT,CAA6B5D,SAA7B,EAAwC;AACtC,QAAMrB,QAAQ,GAAG,IAAIC,gBAAJ,CAAsB,UAAAC,SAAS,EAAI;AAClDA,MAAAA,SAAS,CAACG,OAAV,CAAmB,UAAAC,QAAQ,EAAI;AAC7B,YAAGA,QAAQ,CAAC4E,IAAT,KAAkB,YAAlB,IAAkC5E,QAAQ,CAAC6E,aAAT,KAA2B,KAAhE,EAAuE;AACrE,cAAGvD,cAAH,EAAmB;AACjBiB,YAAAA,iBAAiB;AAClB;AACF;AACF,OAND;AAOD,KARgB,CAAjB;AASA7C,IAAAA,QAAQ,CAACiB,OAAT,CAAiBI,SAAjB,EAA4B;AAAE+D,MAAAA,UAAU,EAAE,IAAd;AAAoBjE,MAAAA,SAAS,EAAE,KAA/B;AAAsCC,MAAAA,OAAO,EAAE;AAA/C,KAA5B;AACD;AACF","file":"main.js","sourceRoot":"..\\..\\src","sourcesContent":["window.addEventListener(\"load\", initialize);\r\nlet initialized = false;\r\n\r\nfunction waitForVideo() {\r\n  var observer = new MutationObserver(mutations => {\r\n    requestIdleCallback(_ => {\r\n      mutations.forEach(mutation => {\r\n        Array.prototype.forEach.call(mutation.addedNodes, node => {\r\n          if (!initialized && node.nodeName === 'VIDEO') {\r\n            observer.disconnect();\r\n            console.log(\"video added, initializing\");\r\n            initialize();\r\n          }\r\n        });\r\n      });\r\n    }, {timeout: 1500});\r\n  });\r\n  observer.observe(document, { childList: true, subtree: true });\r\n}\r\n\r\nfunction initialize() {\r\n  let container = document.querySelector('div.ytp-chrome-bottom');\r\n  if(!initialized && container === null) {\r\n    console.log(\"No container found, waiting for video\");\r\n    waitForVideo();\r\n    return;\r\n  };\r\n\r\n  let video = container.parentNode.querySelector('video');\r\n  if(!initialized && video === null) {\r\n    console.log(\"No video found, waiting for video\");\r\n    waitForVideo();\r\n    return;\r\n  }\r\n\r\n  console.log(\"Initializing looper button\")\r\n  initialized = true;\r\n\r\n  let mainInterval = null;\r\n  let leftMarker = null;\r\n  let rightMarker = null;\r\n  \r\n  // if(video.readyState > 1) {\r\n  //   setup(video.duration);\r\n  // } else {\r\n  //   video.addEventListener('loadedmetadata', () => {\r\n  //     setup(video.duration);\r\n  //   });\r\n  // }\r\n\r\n  let controlsActive = false;\r\n\r\n  const rightControls = container.querySelector('.ytp-right-controls');\r\n  const template = document.createElement('template');\r\n  template.innerHTML = `\r\n    <button class=\"ytp-loop-button ytp-button\" aria-haspopup=true aria-label=\"Toggle A-B repeat\">\r\n      <div class=\"loop-hover-tip\">Toggle A-B repeat</div>\r\n      <div class=\"ytp-loop-icon\"></div>\r\n    </button>\r\n  `;\r\n  const toggleButton = template.content.firstElementChild;\r\n\r\n  const subtitlesButton = container.querySelector('.ytp-subtitles-button');\r\n  rightControls.insertBefore(toggleButton, subtitlesButton);\r\n\r\n  toggleButton.addEventListener('click', e => {\r\n    controlsActive = !controlsActive;\r\n    if(controlsActive) {\r\n      toggleButton.classList.add('active');\r\n      insertMarkers(video.duration);\r\n    } else {\r\n      toggleButton.classList.remove('active');\r\n      removeMarkers();\r\n    }\r\n  });\r\n\r\n  function disableLoopButton() {\r\n    controlsActive = false;\r\n    loopIcon.classList.remove('active');\r\n    removeMarkers();\r\n  }\r\n\r\n  function removeMarkers() {\r\n    console.log(\"Removing loop markers\");\r\n    clearInterval(mainInterval);\r\n    leftMarker.remove();\r\n    rightMarker.remove();\r\n  }\r\n\r\n  function insertMarkers(duration) {\r\n    console.log(\"Setting up loop markers\");\r\n    let leftTime = 0;\r\n    let rightTime = duration;\r\n\r\n    leftMarker = document.createElement('div');\r\n    leftMarker.setAttribute(\"class\", \"looper-marker leftMarker\");\r\n    container.appendChild(leftMarker);\r\n    \r\n    rightMarker = document.createElement('div');\r\n    rightMarker.setAttribute(\"class\", \"looper-marker rightMarker\");\r\n    container.appendChild(rightMarker);\r\n  \r\n    leftMarker.ondragstart = () => false;\r\n    rightMarker.ondragstart = () => false;\r\n  \r\n    let arrowWidth = leftMarker.offsetWidth;\r\n    let shiftX = arrowWidth / 2;\r\n  \r\n    function setPosition(arrow, position) {\r\n      let left = (position - shiftX) + 'px';\r\n      requestAnimationFrame(() => {\r\n        arrow.style.left = left;\r\n      })\r\n    }\r\n  \r\n    function getPosition(arrow) {\r\n      return (arrow.offsetLeft + shiftX);\r\n    }\r\n  \r\n    leftMarker.addEventListener('mousedown', event => {\r\n      event.preventDefault();\r\n      const rightMarkerposition = getPosition(rightMarker);\r\n      const containerLeft = container.getBoundingClientRect().left;\r\n      let containerWidth = container.offsetWidth;\r\n      let position = 0;\r\n    \r\n      document.addEventListener('mousemove', onMouseMove);\r\n      function onMouseMove(event) {\r\n        position = event.clientX - containerLeft;\r\n        if(position < rightMarkerposition && position >= 0 && position <= containerWidth) {\r\n          setPosition(leftMarker, position);\r\n        }\r\n      }\r\n  \r\n      document.addEventListener('mouseup', event => {\r\n        event.preventDefault();\r\n        let percentage = (100 * leftMarker.offsetLeft / containerWidth).toFixed(3);\r\n        leftMarker.style.left = percentage + '%';\r\n        leftTime = (duration * parseFloat(percentage) / 100);\r\n        document.removeEventListener('mousemove', onMouseMove);     \r\n      }, { once: true });\r\n    });\r\n  \r\n    rightMarker.addEventListener('mousedown', event => {\r\n      event.preventDefault();\r\n      const leftMarkerposition = getPosition(leftMarker);\r\n      const containerLeft = container.getBoundingClientRect().left;\r\n      let containerWidth = container.offsetWidth;\r\n      let position = 0;\r\n\r\n      document.addEventListener('mousemove', onMouseMove);\r\n      function onMouseMove(event) {\r\n        position = event.clientX - containerLeft;\r\n        if(position > leftMarkerposition && position >= 0 && position <= containerWidth) {\r\n          setPosition(rightMarker, position);\r\n        }\r\n      }\r\n\r\n      document.addEventListener('mouseup', event => {\r\n        event.preventDefault();\r\n        let percentage = (100 * rightMarker.offsetLeft / containerWidth).toFixed(3);\r\n        rightMarker.style.left = percentage + '%';\r\n        rightTime = (duration * parseFloat(percentage) / 100);\r\n        document.removeEventListener('mousemove', onMouseMove);\r\n      }, { once: true });\r\n    });\r\n\r\n    mainInterval = setInterval(() => {\r\n      let time = video.currentTime;\r\n      if(time > (rightTime - 1) || time < leftTime) {\r\n        video.currentTime = leftTime;\r\n      }\r\n    }, 1000);\r\n\r\n    watchForSouceChange(video);\r\n  }\r\n\r\n  function watchForSouceChange(container) {\r\n    const observer = new MutationObserver( mutations => {\r\n      mutations.forEach( mutation => {\r\n        if(mutation.type === \"attributes\" && mutation.attributeName === \"src\") {\r\n          if(controlsActive) {\r\n            disableLoopButton();\r\n          }\r\n        }\r\n      });\r\n    });\r\n    observer.observe(container, { attributes: true, childList: false, subtree: false });\r\n  }\r\n}"]}